import{m as t,p as e,h as i,d as r,H as s}from"./index-6ad8929d.js";function a(t,e,i){const r=Array.from(t);let s;if(""===e)return s=r.filter(t=>"file"===t.kind),i?s:[s[0]];const a=e.toLowerCase().split(",").map(t=>t.split("/").map(t=>t.trim())).filter(t=>2===t.length);return s=s=r.filter(t=>{if("file"!==t.kind)return!1;const[e,i]=t.type.toLowerCase().split("/").map(t=>t.trim());for(const[t,r]of a)if(e===t&&("*"===r||i===r))return!0;return!1}),!1===i&&(s=[s[0]]),s}function o(t,e,i){return a(t.items,e,i).map(t=>t.getAsFile()).filter(t=>!!t)}class n extends Event{constructor(t,e){var i,r;super(t,e),(i=this)instanceof(r=n)||Object.setPrototypeOf(i,r.prototype),this._files=e.files,this._action=e.action}get action(){return this._action}get files(){return this._files}}class h extends HTMLElement{constructor(){super(),this._dragEnterCount=0,this._onDragEnter=this._onDragEnter.bind(this),this._onDragLeave=this._onDragLeave.bind(this),this._onDrop=this._onDrop.bind(this),this._onPaste=this._onPaste.bind(this),this.addEventListener("dragover",t=>t.preventDefault()),this.addEventListener("drop",this._onDrop),this.addEventListener("dragenter",this._onDragEnter),this.addEventListener("dragend",()=>this._reset()),this.addEventListener("dragleave",this._onDragLeave),this.addEventListener("paste",this._onPaste)}get accept(){return this.getAttribute("accept")||""}set accept(t){this.setAttribute("accept",t)}get multiple(){return this.getAttribute("multiple")}set multiple(t){this.setAttribute("multiple",t||"")}_onDragEnter(t){if(this._dragEnterCount+=1,this._dragEnterCount>1)return;if(null===t.dataTransfer)return void this.classList.add("drop-invalid");const e=a(t.dataTransfer.items,this.accept,null!==this.multiple);!t.dataTransfer||!t.dataTransfer.items.length||void 0!==e[0]?this.classList.add("drop-valid"):this.classList.add("drop-invalid")}_onDragLeave(){this._dragEnterCount-=1,0===this._dragEnterCount&&this._reset()}_onDrop(t){if(t.preventDefault(),null===t.dataTransfer)return;this._reset();const e=o(t.dataTransfer,this.accept,null!==this.multiple);void 0!==e&&this.dispatchEvent(new n("filedrop",{action:"drop",files:e}))}_onPaste(t){if(!t.clipboardData)return;const e=o(t.clipboardData,this.accept,void 0!==this.multiple);void 0!==e&&this.dispatchEvent(new n("filedrop",{action:"paste",files:e}))}_reset(){this._dragEnterCount=0,this.classList.remove("drop-valid"),this.classList.remove("drop-invalid")}}customElements.define("file-drop",h);function u(t,e,i){const r=t.createShader(i);if(t.shaderSource(r,e),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS)){const e=t.getShaderInfoLog(r);throw t.deleteShader(r),Error(e||"unknown error")}return r}function l(t,e){const i=t.createTexture();return t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),i}class c extends t{constructor(){super(...arguments),this._canvasRef=e()}_setup(){const t=this._canvasRef.current.getContext("webgl",{antialias:!1,powerPreference:"low-power"});if(!t)throw Error("Couldn't create GL context");this._gl=t;const e=function(t,e){const i=t.createProgram();for(const r of e)t.attachShader(i,r);if(t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS)){const e=t.getProgramInfoLog(i);throw t.deleteProgram(i),Error(e||"unknown error")}return i}(t,[u(t,"precision lowp float;\n\n// our textures\nuniform sampler2D u_luma;\nuniform sampler2D u_chroma;\nuniform float showY;\nuniform float showCb;\nuniform float showCr;\n\n// the texCoords passed in from the vertex shader.\nvarying vec2 v_texCoord;\n\nvoid main() {\n  vec4 lumaRGB = texture2D(u_luma, v_texCoord).rgba;\n  vec4 chromaRGB = texture2D(u_chroma, v_texCoord).rgba;\n  float y = mix(0.5, 0.256788235 * lumaRGB.r + 0.504129412 * lumaRGB.g + 0.097905882 * lumaRGB.b + 0.062745098, showY);\n  float cb = mix(0.5, -0.148223529 * chromaRGB.r + -0.290992157 * chromaRGB.g + 0.439215686 * chromaRGB.b + 0.501960784, showCb);\n  float cr = mix(0.5, 0.439215686 * chromaRGB.r + -0.367788235 * chromaRGB.g + -0.071427451 * chromaRGB.b + 0.501960784, showCr);\n\n  float yMul = 1.164381 * y;\n\n  gl_FragColor = vec4(\n    yMul + 1.5960195 * cr + -0.8742024,\n    yMul + -0.3917565 * cb + -0.8129655 * cr + 0.5316682,\n    yMul + 2.0172285 * cb + -1.0856326,\n    1\n  );\n}\n",t.FRAGMENT_SHADER),u(t,"precision lowp float;\nattribute vec2 a_position;\nuniform mat3 u_matrix;\nvarying vec2 v_texCoord;\n\nvoid main() {\n   gl_Position = vec4(u_matrix * vec3(a_position, 1), 1);\n\n   // because we're using a unit quad we can just use\n   // the same data for our texcoords.\n   v_texCoord = a_position;\n}\n",t.VERTEX_SHADER)]);t.useProgram(e);const i=t.getAttribLocation(e,"a_position"),r=t.getUniformLocation(e,"u_luma");t.uniform1i(r,0);const s=t.getUniformLocation(e,"u_chroma");t.uniform1i(s,1);const a=t.getUniformLocation(e,"u_matrix");this._showYLoc=t.getUniformLocation(e,"showY"),this._showCbLoc=t.getUniformLocation(e,"showCb"),this._showCrLoc=t.getUniformLocation(e,"showCr");const o=t.createBuffer(),n=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferData(t.ARRAY_BUFFER,n,t.STATIC_DRAW),t.enableVertexAttribArray(i),t.vertexAttribPointer(i,2,t.FLOAT,!1,0,0),t.uniformMatrix3fv(a,!1,[2,0,0,0,-2,0,-1,1,1]),t.uniform1f(this._showYLoc,Number(this.props.showY)),t.uniform1f(this._showCbLoc,Number(this.props.showCb)),t.uniform1f(this._showCrLoc,Number(this.props.showCr))}_updateLuma(){this._lumaTexture&&this._gl.deleteTexture(this._lumaTexture),this._gl.activeTexture(this._gl.TEXTURE0),this._lumaTexture=l(this._gl,this.props.lumaBmp),this._gl.bindTexture(this._gl.TEXTURE_2D,this._lumaTexture)}_updateChroma(){this._chromaTexture&&this._gl.deleteTexture(this._chromaTexture),this._gl.activeTexture(this._gl.TEXTURE1),this._chromaTexture=l(this._gl,this.props.chromaBmp),this._gl.bindTexture(this._gl.TEXTURE_2D,this._chromaTexture)}_draw(){this._gl.drawArrays(this._gl.TRIANGLES,0,6)}componentDidMount(){this._setup(),this._updateLuma(),this._updateChroma(),this._draw()}componentDidUpdate(t){let e=!1;t.width===this.props.width&&t.height===this.props.height||(e=!0,this._gl.viewport(0,0,this._gl.canvas.width,this._gl.canvas.height)),t.chromaBmp!==this.props.chromaBmp&&(e=!0,this._updateChroma()),t.lumaBmp!==this.props.lumaBmp&&(e=!0,this._updateLuma()),t.showY!==this.props.showY&&(this._gl.uniform1f(this._showYLoc,Number(this.props.showY)),e=!0),t.showCb!==this.props.showCb&&(this._gl.uniform1f(this._showCbLoc,Number(this.props.showCb)),e=!0),t.showCr!==this.props.showCr&&(this._gl.uniform1f(this._showCrLoc,Number(this.props.showCr)),e=!0),e&&this._draw()}render({width:t,height:e}){return i("canvas",{class:"_chromaCanvas_kcbaf_1",ref:this._canvasRef,width:t,height:e})}}class m extends t{constructor(){super(...arguments),this._lumaMultiRef=e(),this._chromaMultiRef=e(),this._showYRef=e(),this._showCbRef=e(),this._showCrRef=e(),this._onChange=()=>{this.props.onChange({lumaMulti:this._lumaMultiRef.current.valueAsNumber,chromaMulti:this._chromaMultiRef.current.valueAsNumber,showY:this._showYRef.current.checked,showCb:this._showCbRef.current.checked,showCr:this._showCrRef.current.checked})}}render({lumaMulti:t,chromaMulti:e,width:r,height:s,showY:a,showCb:o,showCr:n}){return i("div",{class:"_controls_10a3c_1"},i("div",{class:"_ranges_10a3c_11"},i("label",{for:"luma-range"},"Luma: "),i("input",{id:"luma-range",ref:this._lumaMultiRef,type:"range",value:t,min:1e-4,max:1,step:"any",onInput:this._onChange}),i("span",{class:"_multiplier_10a3c_21"},t.toFixed(2),"x"),i("span",{class:"_data_10a3c_22"},(t*t).toFixed(3),"x²"),i("span",null,Math.round(r*t),"x",Math.round(s*t)),i("label",{for:"chroma-range"},"Chroma: "),i("input",{id:"chroma-range",ref:this._chromaMultiRef,type:"range",value:e,min:1e-4,max:1,step:"any",onInput:this._onChange}),i("span",{class:"_multiplier_10a3c_21"},e.toFixed(2),"x"),i("span",{class:"_data_10a3c_22"},(e*e).toFixed(3),"x²"),i("span",null,Math.round(r*e),"x",Math.round(s*e))),i("div",{class:"_toggles_10a3c_30"},i("label",{for:"show-y"},"Y"),i("input",{ref:this._showYRef,id:"show-y",type:"checkbox",checked:a,onInput:this._onChange}),i("label",{for:"show-cb"},"Cb"),i("input",{ref:this._showCbRef,id:"show-cb",type:"checkbox",checked:o,onInput:this._onChange}),i("label",{for:"show-cr"},"Cr"),i("input",{ref:this._showCrRef,id:"show-cr",type:"checkbox",checked:n,onInput:this._onChange})))}}const _=new Map(Object.entries(r)),d=new URLSearchParams(location.search),p="1"===d.get("hideUi"),f=_.get(d.get("demo")||""),g=Number(d.get("l"))||1,w=Number(d.get("uv"))||.1;async function C(t,e,i){if(t.width<=e&&t.height<=i)return t;return t.width/t.height>e/i?createImageBitmap(t,{resizeWidth:e,resizeQuality:"high"}):createImageBitmap(t,{resizeHeight:i,resizeQuality:"high"})}async function v(t,e){return 1===e?t:createImageBitmap(t,{resizeWidth:Math.ceil(t.width*e)})}s(i(class extends t{constructor(){super(),this.state={lumaMulti:g,chromaMulti:w,showY:!0,showCb:!0,showCr:!0},this._resizeTimeout=0,this._rangeTimeout=0,this._canvasContainerRef=e(),this._onFileChange=async t=>{const e=t.target;e.files&&e.files[0]&&this._openFile(e.files[0])},this._onDrop=async t=>{this._openFile(t.files[0])},this._onResize=()=>{clearTimeout(this._resizeTimeout),this._resizeTimeout=setTimeout(async()=>{if(!this.state.mainBmp)return;const t=this._canvasContainerRef.current.getBoundingClientRect(),e=await C(this.state.mainBmp,t.width*devicePixelRatio,t.height*devicePixelRatio),[i,r]=await Promise.all([v(e,this.state.lumaMulti),v(e,this.state.chromaMulti)]);this.setState({resizedBmp:e,lumaBmp:i,chromaBmp:r})},100)},this._onControlsChange=t=>{this.setState({chromaMulti:t.chromaMulti,lumaMulti:t.lumaMulti,showY:t.showY,showCb:t.showCb,showCr:t.showCr})},f&&fetch(f).then(t=>t.blob()).then(t=>this._openFile(t))}async _openFile(t){const e=await createImageBitmap(t),i=this._canvasContainerRef.current.getBoundingClientRect(),r=await C(e,i.width*devicePixelRatio,i.height*devicePixelRatio),[s,a]=await Promise.all([v(r,this.state.lumaMulti),v(r,this.state.chromaMulti)]);this.setState({mainBmp:e,resizedBmp:r,lumaBmp:s,chromaBmp:a})}componentDidMount(){addEventListener("resize",this._onResize)}componentWillUnmount(){removeEventListener("resize",this._onResize)}componentDidUpdate(t,e){const i={...this.state};i.lumaMulti===e.lumaMulti&&i.chromaMulti===e.chromaMulti||(clearTimeout(this._rangeTimeout),this._rangeTimeout=setTimeout(async()=>{let t,r;i.lumaMulti!==e.lumaMulti&&(t=v(i.resizedBmp,i.lumaMulti)),i.chromaMulti!==e.chromaMulti&&(r=v(i.resizedBmp,i.chromaMulti));const s={};t&&(s.lumaBmp=await t),r&&(s.chromaBmp=await r),this.setState(s)},20))}render({},{resizedBmp:t,lumaBmp:e,chromaBmp:r,chromaMulti:s,lumaMulti:a,showY:o,showCb:n,showCr:h}){return i("file-drop",{class:"_app_1qm06_19",accept:"image/*",onfiledrop:this._onDrop},i("div",{class:"_layout_1qm06_46"},i("div",{class:"_canvasContainer_1qm06_51",ref:this._canvasContainerRef},t&&e&&r&&i(c,{chromaBmp:r,lumaBmp:e,width:t.width,height:t.height,showY:o,showCb:n,showCr:h})),!p&&i(m,{lumaMulti:a,chromaMulti:s,onChange:this._onControlsChange,width:t?t.width:0,height:t?t.height:0,showY:o,showCb:n,showCr:h})),!p&&i("input",{type:"file",accept:"image/*",onChange:this._onFileChange}))}},null),document.body);
