import{m as e,p as t,h as i,d as r,N as o,a as s,H as a}from"./NavSelect-a007576c.js";function n(e,t,i){const r=e.createShader(i);if(e.shaderSource(r,t),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS)){const t=e.getShaderInfoLog(r);throw e.deleteShader(r),Error(t||"unknown error")}return r}function h(e,t){const i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),i}class u extends e{constructor(){super(...arguments),this._canvasRef=t()}_setup(){const e=this._canvasRef.current.getContext("webgl",{antialias:!1,powerPreference:"low-power"});if(!e)throw Error("Couldn't create GL context");this._gl=e;const t=function(e,t){const i=e.createProgram();for(const r of t)e.attachShader(i,r);if(e.linkProgram(i),!e.getProgramParameter(i,e.LINK_STATUS)){const t=e.getProgramInfoLog(i);throw e.deleteProgram(i),Error(t||"unknown error")}return i}(e,[n(e,"precision lowp float;\n\n// our textures\nuniform sampler2D u_luma;\nuniform sampler2D u_chroma;\nuniform float showY;\nuniform float showCb;\nuniform float showCr;\n\n// the texCoords passed in from the vertex shader.\nvarying vec2 v_texCoord;\n\nvoid main() {\n  vec4 lumaRGB = texture2D(u_luma, v_texCoord).rgba;\n  vec4 chromaRGB = texture2D(u_chroma, v_texCoord).rgba;\n  float y = mix(0.5, 0.256788235 * lumaRGB.r + 0.504129412 * lumaRGB.g + 0.097905882 * lumaRGB.b + 0.062745098, showY);\n  float cb = mix(0.5, -0.148223529 * chromaRGB.r + -0.290992157 * chromaRGB.g + 0.439215686 * chromaRGB.b + 0.501960784, showCb);\n  float cr = mix(0.5, 0.439215686 * chromaRGB.r + -0.367788235 * chromaRGB.g + -0.071427451 * chromaRGB.b + 0.501960784, showCr);\n\n  float yMul = 1.164381 * y;\n\n  gl_FragColor = vec4(\n    yMul + 1.5960195 * cr + -0.8742024,\n    yMul + -0.3917565 * cb + -0.8129655 * cr + 0.5316682,\n    yMul + 2.0172285 * cb + -1.0856326,\n    1\n  );\n}\n",e.FRAGMENT_SHADER),n(e,"precision lowp float;\nattribute vec2 a_position;\nuniform mat3 u_matrix;\nvarying vec2 v_texCoord;\n\nvoid main() {\n   gl_Position = vec4(u_matrix * vec3(a_position, 1), 1);\n\n   // because we're using a unit quad we can just use\n   // the same data for our texcoords.\n   v_texCoord = a_position;\n}\n",e.VERTEX_SHADER)]);e.useProgram(t);const i=e.getAttribLocation(t,"a_position"),r=e.getUniformLocation(t,"u_luma");e.uniform1i(r,0);const o=e.getUniformLocation(t,"u_chroma");e.uniform1i(o,1);const s=e.getUniformLocation(t,"u_matrix");this._showYLoc=e.getUniformLocation(t,"showY"),this._showCbLoc=e.getUniformLocation(t,"showCb"),this._showCrLoc=e.getUniformLocation(t,"showCr");const a=e.createBuffer(),h=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,h,e.STATIC_DRAW),e.enableVertexAttribArray(i),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0),e.uniformMatrix3fv(s,!1,[2,0,0,0,-2,0,-1,1,1]),e.uniform1f(this._showYLoc,Number(this.props.showY)),e.uniform1f(this._showCbLoc,Number(this.props.showCb)),e.uniform1f(this._showCrLoc,Number(this.props.showCr))}_updateLuma(){this._lumaTexture&&this._gl.deleteTexture(this._lumaTexture),this._gl.activeTexture(this._gl.TEXTURE0),this._lumaTexture=h(this._gl,this.props.lumaBmp),this._gl.bindTexture(this._gl.TEXTURE_2D,this._lumaTexture)}_updateChroma(){this._chromaTexture&&this._gl.deleteTexture(this._chromaTexture),this._gl.activeTexture(this._gl.TEXTURE1),this._chromaTexture=h(this._gl,this.props.chromaBmp),this._gl.bindTexture(this._gl.TEXTURE_2D,this._chromaTexture)}_draw(){this._gl.drawArrays(this._gl.TRIANGLES,0,6)}componentDidMount(){this._setup(),this._updateLuma(),this._updateChroma(),this._draw()}componentDidUpdate(e){let t=!1;e.width===this.props.width&&e.height===this.props.height||(t=!0,this._gl.viewport(0,0,this._gl.canvas.width,this._gl.canvas.height)),e.chromaBmp!==this.props.chromaBmp&&(t=!0,this._updateChroma()),e.lumaBmp!==this.props.lumaBmp&&(t=!0,this._updateLuma()),e.showY!==this.props.showY&&(this._gl.uniform1f(this._showYLoc,Number(this.props.showY)),t=!0),e.showCb!==this.props.showCb&&(this._gl.uniform1f(this._showCbLoc,Number(this.props.showCb)),t=!0),e.showCr!==this.props.showCr&&(this._gl.uniform1f(this._showCrLoc,Number(this.props.showCr)),t=!0),t&&this._draw()}render({width:e,height:t}){return i("canvas",{class:"_chromaCanvas_l1vsy_1",ref:this._canvasRef,width:e,height:t})}}class c extends e{constructor(){super(...arguments),this._lumaMultiRef=t(),this._chromaMultiRef=t(),this._showYRef=t(),this._showCbRef=t(),this._showCrRef=t(),this._resizeTypeRef=t(),this._onChange=()=>{this.props.onChange({lumaMulti:this._lumaMultiRef.current.valueAsNumber,chromaMulti:this._chromaMultiRef.current.valueAsNumber,showY:this._showYRef.current.checked,showCb:this._showCbRef.current.checked,showCr:this._showCrRef.current.checked,resizeType:this._resizeTypeRef.current.value})}}render({lumaMulti:e,chromaMulti:t,width:r,height:o,showY:s,showCb:a,showCr:n,resizeType:h}){return i("div",{class:"_controls_1cm3m_1"},i("div",{class:"_ranges_1cm3m_11"},i("label",{for:"luma-range"},"Luma: "),i("input",{id:"luma-range",ref:this._lumaMultiRef,type:"range",value:e,min:1e-4,max:1,step:"any",onInput:this._onChange}),i("span",{class:"_multiplier_1cm3m_22"},e.toFixed(2),"x"),i("span",{class:"_data_1cm3m_23"},(e*e).toFixed(3),"x²"),i("span",null,Math.round(r*e)||1,"x",Math.round(o*e)||1),i("label",{for:"chroma-range"},"Chroma: "),i("input",{id:"chroma-range",ref:this._chromaMultiRef,type:"range",value:t,min:1e-4,max:1,step:"any",onInput:this._onChange}),i("span",{class:"_multiplier_1cm3m_22"},t.toFixed(2),"x"),i("span",{class:"_data_1cm3m_23"},(t*t).toFixed(3),"x²"),i("span",null,Math.round(r*t)||1,"x",Math.round(o*t)||1)),i("div",{class:"_extraOptions_1cm3m_31"},i("div",{class:"_resizeMethod_1cm3m_48"},i("label",{for:"resize-method"},"Method:"),i("select",{ref:this._resizeTypeRef,id:"resize-method",onInput:this._onChange,value:h},i("option",{value:"triangle"},"Bilinear"),i("option",{value:"catrom"},"Catmull-Rom"),i("option",{value:"mitchell"},"Mitchell"),i("option",{value:"lanczos3"},"Lanczos3"))),i("div",{class:"_toggles_1cm3m_39"},i("label",{for:"show-y"},"Y"),i("input",{ref:this._showYRef,id:"show-y",type:"checkbox",checked:s,onInput:this._onChange}),i("label",{for:"show-cb"},"Cb"),i("input",{ref:this._showCbRef,id:"show-cb",type:"checkbox",checked:a,onInput:this._onChange}),i("label",{for:"show-cr"},"Cr"),i("input",{ref:this._showCrRef,id:"show-cr",type:"checkbox",checked:n,onInput:this._onChange}))))}}async function l(e,t){if(e.aborted)throw new DOMException("AbortError","AbortError");return Promise.race([t,new Promise((t,i)=>{e.addEventListener("abort",()=>i(new DOMException("AbortError","AbortError")))})])}class m{constructor(){this._queue=Promise.resolve(),this._pendingId=0,this._initWorker()}_cycleWorker(){this._worker.terminate(),this._initWorker()}_initWorker(){this._worker=new Worker("/image-experiments/index-c066022b.js")}resize(e,...t){return this._queue=this._queue.catch(()=>{}).then(async()=>{if(e.aborted)throw new DOMException("AbortError","AbortError");const i=Math.random(),r={id:i,args:t,action:"resize"};return this._pendingId=i,e.addEventListener("abort",()=>{this._pendingId===i&&this._cycleWorker()}),l(e,new Promise(e=>{this._worker.addEventListener("message",(function(t){if(t.data.id!==i)return;const r=t.data;e(r.result)})),this._worker.postMessage(r)}))})}}const _=new m,p=new m;async function d(e){if("createImageBitmap"in window)return createImageBitmap(e);const t=URL.createObjectURL(e);try{return await async function(e){const t=new Image;return t.decoding="async",t.src=e,await t.decode(),t}(t)}finally{URL.revokeObjectURL(t)}}async function w(e,t,{width:i,height:r,type:o="lanczos3",asyncResize:s=_}={}){let a,n;if(void 0!==i)a=Math.round(i)||1,n=Math.round(t.height*i/t.width)||1;else{if(void 0===r)throw Error("Must specify width or height");n=Math.round(r)||1,a=Math.round(t.width*r/t.height)||1}return s.resize(e,t,a,n,o)}async function g(e,t,i,r,o){return 1===i?t:w(e,t,{width:t.width*i,type:r,asyncResize:o})}const f=new Map(Object.entries(r)),C=new URLSearchParams(location.search),R="1"===C.get("hideUi"),b=f.get(C.get("demo")||""),T=Number(C.get("l"))||1,v=Number(C.get("uv"))||.1;a(i(class extends e{constructor(){super(),this.state={loading:!1,lumaMulti:T,chromaMulti:v,showY:!0,showCb:!0,showCr:!0,resizeType:"lanczos3"},this._resizeTimeout=0,this._rangeTimeout=0,this._canvasContainerRef=t(),this._fileInput=t(),this._onFileChange=async e=>{const t=e.target;t.files&&t.files[0]&&this._openFile(t.files[0])},this._onDrop=e=>{this._openFile(e.files[0])},this._onResize=()=>{clearTimeout(this._resizeTimeout),this._resizeTimeout=setTimeout(async()=>{this.state.mainBmp&&this._update({updateResized:!0,updateChroma:!0,updateLuma:!0})},100)},this._onControlsChange=e=>{this.setState({chromaMulti:e.chromaMulti,lumaMulti:e.lumaMulti,showY:e.showY,showCb:e.showCb,showCr:e.showCr,resizeType:e.resizeType})},this._onDemoImgSelect=e=>{e&&this._loadImage(e)},this._openFileClick=()=>{this._fileInput.current.click()},b&&this._loadImage(b)}async _update({updateMain:e,updateResized:t,updateChroma:i,updateLuma:r}={}){this._updateController&&this._updateController.abort(),this._updateController=new AbortController;const{signal:o}=this._updateController;try{const s=e?function(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const i=t.getContext("2d");if(!i)throw new Error("Could not create canvas context");return i.drawImage(e,0,0),i.getImageData(0,0,t.width,t.height)}(await l(o,d(e))):this.state.mainBmp,a=this._canvasContainerRef.current.getBoundingClientRect(),n=t?await async function(e,t,i,r){return t.width<=i&&t.height<=r?t:w(e,t,t.width/t.height>i/r?{width:i}:{height:r})}(o,s,a.width*devicePixelRatio,a.height*devicePixelRatio):this.state.resizedBmp,[h,u]=await Promise.all([r?g(o,n,this.state.lumaMulti,this.state.resizeType,_):this.state.lumaBmp,i?g(o,n,this.state.chromaMulti,this.state.resizeType,p):this.state.chromaBmp]);this.setState({mainBmp:s,resizedBmp:n,lumaBmp:h,chromaBmp:u,loading:!1})}catch(e){if("AbortError"===e.name)return;throw e}}async _openFile(e){this.setState({loading:!0}),this._update({updateMain:e,updateResized:!0,updateChroma:!0,updateLuma:!0})}_loadImage(e){this.setState({loading:!0}),fetch(e).then(e=>e.blob()).then(e=>this._openFile(e))}componentDidMount(){addEventListener("resize",this._onResize)}componentWillUnmount(){removeEventListener("resize",this._onResize)}componentDidUpdate(e,t){const i=this.state.resizeType!==t.resizeType,r=i||this.state.chromaMulti!==t.chromaMulti,o=i||this.state.lumaMulti!==t.lumaMulti;(r||o)&&(clearTimeout(this._rangeTimeout),this._rangeTimeout=setTimeout(()=>{this._update({updateChroma:r,updateLuma:o})},20))}render({},{loading:e,resizedBmp:t,lumaBmp:r,chromaBmp:a,chromaMulti:n,lumaMulti:h,showY:l,showCb:m,showCr:_,resizeType:p}){return i("file-drop",{class:"_app_16n5p_23",accept:"image/*",onfiledrop:this._onDrop},i("div",{class:"_layout_16n5p_50"},i("div",{class:"_canvasContainer_16n5p_55",ref:this._canvasContainerRef},e?i("div",null,"…loading…"):!!(t&&r&&a)&&i(u,{chromaBmp:a,lumaBmp:r,width:t.width,height:t.height,showY:l,showCb:m,showCr:_})),!R&&i(c,{lumaMulti:h,chromaMulti:n,onChange:this._onControlsChange,width:t?t.width:0,height:t?t.height:0,showY:l,showCb:m,showCr:_,resizeType:p})),!R&&i("div",{class:"_file-options_16n5p_13"},i("button",{onClick:this._openFileClick},"Open file"),i("input",{ref:this._fileInput,type:"file",accept:"image/*",onChange:this._onFileChange})," ",i(o,{onChange:this._onDemoImgSelect},i("option",{value:""},"Or pick a demo"),Object.entries(s).map(([e,t])=>i("option",{value:t},e)))))}},null),document.body);
