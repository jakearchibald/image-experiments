import{m as t,p as e,h as o,d as r,N as i,b as s,H as a}from"./NavSelect-22658f67.js";function h(t,e,o){const r=t.createShader(o);if(t.shaderSource(r,e),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS)){const e=t.getShaderInfoLog(r);throw t.deleteShader(r),Error(e||"unknown error")}return r}function n(t,e,o){const r=t.createTexture();return t.bindTexture(t.TEXTURE_2D,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,o?t.LINEAR:t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,o?t.LINEAR:t.NEAREST),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),r}class u extends t{constructor(){super(...arguments),this._canvasRef=e()}_setup(){const t=this._canvasRef.current.getContext("webgl",{antialias:!1,powerPreference:"low-power"});if(!t)throw Error("Couldn't create GL context");this._gl=t;const e=function(t,e){const o=t.createProgram();for(const r of e)t.attachShader(o,r);if(t.linkProgram(o),!t.getProgramParameter(o,t.LINK_STATUS)){const e=t.getProgramInfoLog(o);throw t.deleteProgram(o),Error(e||"unknown error")}return o}(t,[h(t,"precision lowp float;\n\n// our textures\nuniform sampler2D u_luma;\nuniform sampler2D u_chroma;\nuniform float showY;\nuniform float showCb;\nuniform float showCr;\n\n// the texCoords passed in from the vertex shader.\nvarying vec2 v_texCoord;\n\nvoid main() {\n  vec4 lumaRGB = texture2D(u_luma, v_texCoord).rgba;\n  vec4 chromaRGB = texture2D(u_chroma, v_texCoord).rgba;\n  float y = mix(0.5, 0.256788235 * lumaRGB.r + 0.504129412 * lumaRGB.g + 0.097905882 * lumaRGB.b + 0.062745098, showY);\n  float cb = mix(0.5, -0.148223529 * chromaRGB.r + -0.290992157 * chromaRGB.g + 0.439215686 * chromaRGB.b + 0.501960784, showCb);\n  float cr = mix(0.5, 0.439215686 * chromaRGB.r + -0.367788235 * chromaRGB.g + -0.071427451 * chromaRGB.b + 0.501960784, showCr);\n\n  float yMul = 1.164381 * y;\n\n  gl_FragColor = vec4(\n    yMul + 1.5960195 * cr + -0.8742024,\n    yMul + -0.3917565 * cb + -0.8129655 * cr + 0.5316682,\n    yMul + 2.0172285 * cb + -1.0856326,\n    1\n  );\n}\n",t.FRAGMENT_SHADER),h(t,"precision lowp float;\nattribute vec2 a_position;\nuniform mat3 u_matrix;\nvarying vec2 v_texCoord;\n\nvoid main() {\n   gl_Position = vec4(u_matrix * vec3(a_position, 1), 1);\n\n   // because we're using a unit quad we can just use\n   // the same data for our texcoords.\n   v_texCoord = a_position;\n}\n",t.VERTEX_SHADER)]);t.useProgram(e);const o=t.getAttribLocation(e,"a_position"),r=t.getUniformLocation(e,"u_luma");t.uniform1i(r,0);const i=t.getUniformLocation(e,"u_chroma");t.uniform1i(i,1);const s=t.getUniformLocation(e,"u_matrix");this._showYLoc=t.getUniformLocation(e,"showY"),this._showCbLoc=t.getUniformLocation(e,"showCb"),this._showCrLoc=t.getUniformLocation(e,"showCr");const a=t.createBuffer(),n=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);t.bindBuffer(t.ARRAY_BUFFER,a),t.bufferData(t.ARRAY_BUFFER,n,t.STATIC_DRAW),t.enableVertexAttribArray(o),t.vertexAttribPointer(o,2,t.FLOAT,!1,0,0),t.uniformMatrix3fv(s,!1,[2,0,0,0,-2,0,-1,1,1]),t.uniform1f(this._showYLoc,Number(this.props.showY)),t.uniform1f(this._showCbLoc,Number(this.props.showCb)),t.uniform1f(this._showCrLoc,Number(this.props.showCr))}_updateLuma(){this._lumaTexture&&this._gl.deleteTexture(this._lumaTexture),this._gl.activeTexture(this._gl.TEXTURE0),this._lumaTexture=n(this._gl,this.props.lumaBmp,!0),this._gl.bindTexture(this._gl.TEXTURE_2D,this._lumaTexture)}_updateChroma(){this._chromaTexture&&this._gl.deleteTexture(this._chromaTexture),this._gl.activeTexture(this._gl.TEXTURE1),this._chromaTexture=n(this._gl,this.props.chromaBmp,this.props.smoothChroma),this._gl.bindTexture(this._gl.TEXTURE_2D,this._chromaTexture)}_draw(){this._gl.drawArrays(this._gl.TRIANGLES,0,6)}componentDidMount(){this._setup(),this._updateLuma(),this._updateChroma(),this._draw()}componentDidUpdate(t){let e=!1;t.width===this.props.width&&t.height===this.props.height||(e=!0,this._gl.viewport(0,0,this._gl.canvas.width,this._gl.canvas.height)),t.chromaBmp===this.props.chromaBmp&&t.smoothChroma===this.props.smoothChroma||(e=!0,this._updateChroma()),t.lumaBmp!==this.props.lumaBmp&&(e=!0,this._updateLuma()),t.showY!==this.props.showY&&(this._gl.uniform1f(this._showYLoc,Number(this.props.showY)),e=!0),t.showCb!==this.props.showCb&&(this._gl.uniform1f(this._showCbLoc,Number(this.props.showCb)),e=!0),t.showCr!==this.props.showCr&&(this._gl.uniform1f(this._showCrLoc,Number(this.props.showCr)),e=!0),e&&this._draw()}render({width:t,height:e}){return o("canvas",{class:"_chromaCanvas_l1vsy_1",ref:this._canvasRef,width:t,height:e})}}class c extends t{constructor(){super(...arguments),this._lumaMultiRef=e(),this._chromaMultiRef=e(),this._showYRef=e(),this._showCbRef=e(),this._showCrRef=e(),this._smoothCbCr=e(),this._resizeTypeRef=e(),this._onChange=()=>{this.props.onChange({lumaMulti:this._lumaMultiRef.current.valueAsNumber,chromaMulti:this._chromaMultiRef.current.valueAsNumber,showY:this._showYRef.current.checked,showCb:this._showCbRef.current.checked,showCr:this._showCrRef.current.checked,smoothCbCr:this._smoothCbCr.current.checked,resizeType:this._resizeTypeRef.current.value})}}render({lumaMulti:t,chromaMulti:e,width:r,height:i,showY:s,showCb:a,showCr:h,smoothCbCr:n,resizeType:u}){return o("div",{class:"_controls_1vhht_1"},o("div",{class:"_ranges_1vhht_11"},o("label",{for:"luma-range"},"Luma: "),o("input",{id:"luma-range",ref:this._lumaMultiRef,type:"range",value:t,min:1e-4,max:1,step:"any",onInput:this._onChange}),o("span",{class:"_multiplier_1vhht_22"},t.toFixed(2),"x"),o("span",{class:"_data_1vhht_23"},(t*t).toFixed(3),"x²"),o("span",null,Math.round(r*t)||1,"x",Math.round(i*t)||1),o("label",{for:"chroma-range"},"Chroma: "),o("input",{id:"chroma-range",ref:this._chromaMultiRef,type:"range",value:e,min:1e-4,max:1,step:"any",onInput:this._onChange}),o("span",{class:"_multiplier_1vhht_22"},e.toFixed(2),"x"),o("span",{class:"_data_1vhht_23"},(e*e).toFixed(3),"x²"),o("span",null,Math.round(r*e)||1,"x",Math.round(i*e)||1)),o("div",{class:"_extraOptions_1vhht_31"},o("div",{class:"_resizeMethod_1vhht_52"},o("label",{for:"resize-method"},"Method:"),o("select",{ref:this._resizeTypeRef,id:"resize-method",onInput:this._onChange,value:u},o("option",{value:"triangle"},"Bilinear"),o("option",{value:"catrom"},"Catmull-Rom"),o("option",{value:"mitchell"},"Mitchell"),o("option",{value:"lanczos3"},"Lanczos3"))),o("div",{class:"_toggles-rows_1vhht_39"},o("div",{class:"_toggles_1vhht_39"},o("label",null,o("input",{ref:this._showYRef,type:"checkbox",checked:s,onInput:this._onChange})," ","Y")," ",o("label",null,o("input",{ref:this._showCbRef,type:"checkbox",checked:a,onInput:this._onChange})," ","Cb")," ",o("label",null,o("input",{ref:this._showCrRef,type:"checkbox",checked:h,onInput:this._onChange})," ","Cr")),o("div",null,o("label",null,o("input",{ref:this._smoothCbCr,type:"checkbox",checked:n,onInput:this._onChange})," ","Smooth CbCr")))))}}async function l(t,e){if(t.aborted)throw new DOMException("AbortError","AbortError");return Promise.race([e,new Promise((e,o)=>{t.addEventListener("abort",()=>o(new DOMException("AbortError","AbortError")))})])}class m{constructor(){this._queue=Promise.resolve(),this._pendingId=0,this._initWorker()}_cycleWorker(){this._worker.terminate(),this._initWorker()}_initWorker(){this._worker=new Worker("/image-experiments/index-c066022b.js")}resize(t,...e){return this._queue=this._queue.catch(()=>{}).then(async()=>{if(t.aborted)throw new DOMException("AbortError","AbortError");const o=Math.random(),r={id:o,args:e,action:"resize"};return this._pendingId=o,t.addEventListener("abort",()=>{this._pendingId===o&&this._cycleWorker()}),l(t,new Promise(t=>{this._worker.addEventListener("message",(function(e){if(e.data.id!==o)return;const r=e.data;t(r.result)})),this._worker.postMessage(r)}))})}}const _=new m,p=new m;async function d(t){if("createImageBitmap"in window)return createImageBitmap(t);const e=URL.createObjectURL(t);try{return await async function(t){const e=new Image;return e.decoding="async",e.src=t,await e.decode(),e}(e)}finally{URL.revokeObjectURL(e)}}async function g(t,e,{width:o,height:r,type:i="lanczos3",asyncResize:s=_}={}){let a,h;if(void 0!==o)a=Math.round(o)||1,h=Math.round(e.height*o/e.width)||1;else{if(void 0===r)throw Error("Must specify width or height");h=Math.round(r)||1,a=Math.round(e.width*r/e.height)||1}return s.resize(t,e,a,h,i)}async function w(t,e,o,r,i){return 1===o?e:g(t,e,{width:e.width*o,type:r,asyncResize:i})}const f=new Map(Object.entries(r)),C=new URLSearchParams(location.search),b="1"===C.get("hideUi"),R=f.get(C.get("demo")||""),T=Number(C.get("l"))||1,v=Number(C.get("uv"))||.1;a(o(class extends t{constructor(){super(...arguments),this.state={loading:!1,lumaMulti:T,chromaMulti:v,showY:!0,showCb:!0,showCr:!0,smoothCbCr:!0,resizeType:"lanczos3"},this._resizeTimeout=0,this._rangeTimeout=0,this._canvasContainerRef=e(),this._fileInput=e(),this._onFileChange=async t=>{const e=t.target;e.files&&e.files[0]&&this._openFile(e.files[0])},this._onDrop=t=>{this._openFile(t.files[0])},this._onResize=()=>{clearTimeout(this._resizeTimeout),this._resizeTimeout=setTimeout(async()=>{this.state.mainBmp&&this._update({updateResized:!0,updateChroma:!0,updateLuma:!0})},100)},this._onControlsChange=t=>{this.setState({chromaMulti:t.chromaMulti,lumaMulti:t.lumaMulti,showY:t.showY,showCb:t.showCb,showCr:t.showCr,smoothCbCr:t.smoothCbCr,resizeType:t.resizeType})},this._onDemoImgSelect=t=>{t&&this._loadImage(t)},this._openFileClick=()=>{this._fileInput.current.click()}}async _update({updateMain:t,updateResized:e,updateChroma:o,updateLuma:r}={}){this._updateController&&this._updateController.abort(),this._updateController=new AbortController;const{signal:i}=this._updateController;try{const s=t?function(t){const e=document.createElement("canvas");e.width=t.width,e.height=t.height;const o=e.getContext("2d");if(!o)throw new Error("Could not create canvas context");return o.drawImage(t,0,0),o.getImageData(0,0,e.width,e.height)}(await l(i,d(t))):this.state.mainBmp,a=this._canvasContainerRef.current.getBoundingClientRect(),h=e?await async function(t,e,o,r){return e.width<=o&&e.height<=r?e:g(t,e,e.width/e.height>o/r?{width:o}:{height:r})}(i,s,a.width*devicePixelRatio,a.height*devicePixelRatio):this.state.resizedBmp,[n,u]=await Promise.all([r?w(i,h,this.state.lumaMulti,this.state.resizeType,_):this.state.lumaBmp,o?w(i,h,this.state.chromaMulti,this.state.resizeType,p):this.state.chromaBmp]);this.setState({mainBmp:s,resizedBmp:h,lumaBmp:n,chromaBmp:u,loading:!1})}catch(t){if("AbortError"===t.name)return;throw t}}async _openFile(t){this.setState({loading:!0}),this._update({updateMain:t,updateResized:!0,updateChroma:!0,updateLuma:!0})}_loadImage(t){this.setState({loading:!0}),fetch(t).then(t=>t.blob()).then(t=>this._openFile(t))}componentDidMount(){addEventListener("resize",this._onResize),R&&this._loadImage(R)}componentWillUnmount(){removeEventListener("resize",this._onResize)}componentDidUpdate(t,e){const o=this.state.resizeType!==e.resizeType,r=o||this.state.chromaMulti!==e.chromaMulti,i=o||this.state.lumaMulti!==e.lumaMulti;(r||i)&&(clearTimeout(this._rangeTimeout),this._rangeTimeout=setTimeout(()=>{this._update({updateChroma:r,updateLuma:i})},20))}render({},{loading:t,resizedBmp:e,lumaBmp:r,chromaBmp:a,chromaMulti:h,lumaMulti:n,showY:l,showCb:m,showCr:_,smoothCbCr:p,resizeType:d}){return o("file-drop",{class:"_app_16n5p_23",accept:"image/*",onfiledrop:this._onDrop},o("div",{class:"_layout_16n5p_50"},o("div",{class:"_canvasContainer_16n5p_55",ref:this._canvasContainerRef},t?o("div",null,"…loading…"):!!(e&&r&&a)&&o(u,{chromaBmp:a,lumaBmp:r,width:e.width,height:e.height,showY:l,showCb:m,showCr:_,smoothChroma:p})),!b&&o(c,{lumaMulti:n,chromaMulti:h,onChange:this._onControlsChange,width:e?e.width:0,height:e?e.height:0,showY:l,showCb:m,showCr:_,smoothCbCr:p,resizeType:d})),!b&&o("div",{class:"_file-options_16n5p_13"},o("button",{onClick:this._openFileClick},"Open file"),o("input",{ref:this._fileInput,type:"file",accept:"image/*",onChange:this._onFileChange})," ",o(i,{onChange:this._onDemoImgSelect},o("option",{value:""},"Or pick a demo"),Object.entries(s).map(([t,e])=>o("option",{value:e},t)))))}},null),document.body);
